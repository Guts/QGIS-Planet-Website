---
source: "blog"
title: "Zonal Operations using PostGIS"
date: "2024-06-24T00:00:00"
link: "https://kartoza.com/blog/database/zonal-operations-using-postgis"
draft: "false"
showcase: "planet"
subscribers: ["kartoza"]
author: "Kartoza"
tags: ["database"]
languages: ["en_gb"]
available_languages: ["en_gb"]
---

<div class="ql-editor read-mode"><p>Recently I have been reviewing training materials from the <a href="https://changelog.qgis.org/en/qgis/" rel="noopener noreferrer">QGIS Changelog site</a>. One particular lesson I liked was how to do <a href="https://changelog.qgis.org/en/qgis/lesson/raster-16/detail/57/?q=7.7" rel="noopener noreferrer">Zonal Operations</a>. I thought about how to replicate the output produced in the lesson using Cloud storage and the PostGIS database.</p><p><br /></p><p>The basis of this tutorial assumes a user has the following:</p><ol><li><span class="ql-ui" contenteditable="false"></span>Cloud Storage. This could be Minio or Amazon S3 buckets or any other storage providers.</li><li><span class="ql-ui" contenteditable="false"></span>A PostgreSQL database instance.</li><li><span class="ql-ui" contenteditable="false"></span>ogr_fdw extension installed in the PostgreSQL database.</li></ol><p><br /></p><p>For a local setup, I am using a docker-compose setup.</p><p><br /></p><pre class="ql-code-block-container"><div class="ql-code-block">version: '3.9'</div><div class="ql-code-block">volumes:</div><div class="ql-code-block"> &nbsp;postgis-data:</div><div class="ql-code-block"> &nbsp;minio_data:</div><div class="ql-code-block"><br /></div><div class="ql-code-block">services:</div><div class="ql-code-block"><br /></div><div class="ql-code-block"> &nbsp;minio:</div><div class="ql-code-block"> &nbsp; &nbsp;image: quay.io/minio/minio</div><div class="ql-code-block"> &nbsp; &nbsp;environment:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- MINIO_ROOT_USER=minio_admin</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- MINIO_ROOT_PASSWORD=secure_minio_secret</div><div class="ql-code-block"> &nbsp; &nbsp;entrypoint: /bin/bash</div><div class="ql-code-block"> &nbsp; &nbsp;command: -c 'minio server /data --console-address ":9001"'</div><div class="ql-code-block"> &nbsp; &nbsp;volumes:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- minio_data:/mapproxy</div><div class="ql-code-block"> &nbsp; &nbsp;ports:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- "9000:9000"</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- "9001:9001"</div><div class="ql-code-block"><br /></div><div class="ql-code-block"> &nbsp;db:</div><div class="ql-code-block"> &nbsp; &nbsp;image: kartoza/postgis:16-3.4</div><div class="ql-code-block"> &nbsp; &nbsp;volumes:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- postgis-data:/var/lib/postgresql</div><div class="ql-code-block"> &nbsp; &nbsp;environment:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- POSTGRES_DB=gis</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- POSTGRES_USER=docker</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- POSTGRES_PASS=docker</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- ALLOW_IP_RANGE=0.0.0.0/0</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;# Add extensions you need to be enabled by default in the DB. Default are the five specified below</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- POSTGRES_MULTIPLE_EXTENSIONS=postgis,hstore,postgis_topology,postgis_raster,pgrouting,ogr_fdw</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- RUN_AS_ROOT=true</div><div class="ql-code-block"> &nbsp; &nbsp;ports:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;- "25432:5432"</div><div class="ql-code-block"> &nbsp; &nbsp;restart: on-failure</div><div class="ql-code-block"> &nbsp; &nbsp;depends_on:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;minio:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp; &nbsp;condition: service_started</div><div class="ql-code-block"> &nbsp; &nbsp;healthcheck:</div><div class="ql-code-block"> &nbsp; &nbsp; &nbsp;test: "PGPASSWORD=docker pg_isready -h 127.0.0.1 -U docker -d gis"</div></pre><p><br /></p><ol><li><span class="ql-ui" contenteditable="false"></span>Use the docker-compose specified above to bring the services up. `docker-compose up -d`</li><li><span class="ql-ui" contenteditable="false"></span>Navigate to the MinIO UI and create a bucket i.e. `postgis`.</li><li><span class="ql-ui" contenteditable="false"></span>Download sample datasets from the <a href="https://changelog.qgis.org/en/qgis/lesson/raster-16/detail/57/?q=7.7" rel="noopener noreferrer">training tutorial</a> and upload the datasets into the bucket you created in step 2.</li><li><span class="ql-ui" contenteditable="false"></span>Exec into the PostgreSQL container using the command `docker-compose exec db bash`.</li><li><span class="ql-ui" contenteditable="false"></span>Install postgis which will allow you to access the raster tool `raster2pgsql`</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">apt get update;apt install -y postgis</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>Load the raster data into the database</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">export PGPASSWORD="docker"</div><div class="ql-code-block">raster2pgsql -s 3857 -t 256x256 -I -R /vsicurl/http://minio:9000/postgis/kzn_pop_count.tif kzn_pop_count | psql -d gis -p 5432 -U docker -h localhost</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>Use GDAL to see if you can access the spatial data stored in the MinIO bucket.</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">ogrinfo -ro -al -so /vsicurl/http://minio:9000/postgis/districts.shp</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>Login to the database using psql command line.</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">psql -d gis -p 5432 -U docker -h localhost</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>Run he SQL commands to create a server and foreign table accessing the remote vector data.</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">-- Create remote server to interact with vector layer stored in minio bucket</div><div class="ql-code-block">CREATE SERVER remote_shp</div><div class="ql-code-block">	FOREIGN DATA WRAPPER ogr_fdw</div><div class="ql-code-block">	OPTIONS (</div><div class="ql-code-block"> &nbsp;datasource '/vsicurl/http://minio:9000/postgis/districts.shp',</div><div class="ql-code-block"> &nbsp;format 'ESRI Shapefile' );</div><div class="ql-code-block">	</div><div class="ql-code-block">-- create foreign table to map the vector layer into the DB	</div><div class="ql-code-block">CREATE FOREIGN TABLE "districts" (</div><div class="ql-code-block">	fid integer,</div><div class="ql-code-block">	"geom" geometry(MultiPolygon, 4326),</div><div class="ql-code-block">	"name" varchar ,</div><div class="ql-code-block">	"DISTRICT" varchar ,</div><div class="ql-code-block">	"PROVINCE" varchar)</div><div class="ql-code-block">	SERVER remote_shp</div><div class="ql-code-block">	OPTIONS (layer 'districts');</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>To speed up accessing the foreign table we create a materialized view of the vector layer.</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">--Also project the geom to match the CRS of the raster layer</div><div class="ql-code-block">CREATE materialized view mv_districts as</div><div class="ql-code-block">SELECT fid,name, "DISTRICT" as district, "PROVINCE" as province, st_transform(geom,3857) as geom</div><div class="ql-code-block">from districts;</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>Run the SQL for generating zonal statistics.</li></ol><pre class="ql-code-block-container"><div class="ql-code-block">SELECT</div><div class="ql-code-block"> &nbsp; &nbsp;-- provides: count | sum | mean | stddev | min | max</div><div class="ql-code-block"> &nbsp; &nbsp;(ST_SummaryStats(ST_Clip(kzn_pop_count.rast, mv_districts.geom, TRUE))).*,</div><div class="ql-code-block"> &nbsp; &nbsp;mv_districts.name AS name,</div><div class="ql-code-block"> &nbsp; &nbsp;mv_districts.geom AS geometry</div><div class="ql-code-block"><br /></div><div class="ql-code-block">FROM</div><div class="ql-code-block"> &nbsp; &nbsp;kzn_pop_count, mv_districts;</div></pre><ol><li><span class="ql-ui" contenteditable="false"></span>If your raster data has multiple bands the SQL above will not work and should be adjusted in the following part `uST_Clip(kzn_pop_count.rast,1, mv_districts.geom` or alternatively use GDAL to translate the raster, extracting the band you need before uploading the raster layer in step 3, or pass the `-b 1` option in `raster2pgsql` command .</li></ol><p><br /></p><p>There are multiple ways to tackle geospatial problems and various software provides different methods to use. Storing data on cloud storage providers allows multiple tools to access the same datasets and thereby allowing various analysis to be formulated.</p></div>
